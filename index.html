<!doctype html>
<html lang="my" data-theme="light" data-preset="cyan">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JVPN VIP DNS CREATOR</title>

  <!-- Favicon (inline SVG) -->
  <link rel="icon" href='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop stop-color="%2314b8a6"/><stop offset="0.5" stop-color="%2306b6d4"/><stop offset="1" stop-color="%236366f1"/></linearGradient></defs><rect rx="14" ry="14" width="64" height="64" fill="url(%23g)"/><text x="50%" y="53%" font-family="Segoe UI,Roboto" font-size="28" fill="white" text-anchor="middle">J</text></svg>'>

  <style>
    :root{
      --fg:#0b1220; --muted:#5b6b84; --line:#d8e3ee;
      --accent:#14b8a6; --accent-ink:#0ea5e9; --ok:#10b981; --ok-bright:#059669;
      --warn:#f59e0b; --err:#ef4444; --time:#8b5cf6; --loc:#06b6d4;
      --bg1:#eef2ff; --bg2:#e0fbff; --bg3:#fae8ff; --card:#ffffffcf; --card-tint:#f8fafc;
      --tri: linear-gradient(90deg, #14b8a6 0%, #06b6d4 50%, #6366f1 100%);
      --shadow-strong: 0 20px 40px rgba(11,18,32,.12); --shadow-soft: 0 8px 20px rgba(11,18,32,.05);
      --card-bg-plain:#ffffffd9; --table-row:#fff;
      --grain: url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' width='140' height='140' viewBox='0 0 140 140'>\
<filter id='f'><feTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='2' stitchTiles='stitch'/><feColorMatrix type='saturate' values='0'/><feComponentTransfer><feFuncA type='linear' slope='0.035'/></feComponentTransfer></filter>\
<rect width='100%' height='100%' filter='url(#f)'/></svg>");
    }
    /* Theme presets (you can switch via data-preset="cyan|emerald|sunset") */
    [data-preset="emerald"]{
      --accent:#10b981; --accent-ink:#059669; --ok:#22c55e; --ok-bright:#16a34a;
      --bg1:#e8fff3; --bg2:#ddfbe9; --bg3:#f0fff7; --tri:linear-gradient(90deg,#10b981 0%, #22c55e 50%, #06b6d4 100%);
    }
    [data-preset="sunset"]{
      --accent:#fb7185; --accent-ink:#f43f5e; --ok:#f59e0b; --ok-bright:#d97706;
      --bg1:#fff1f2; --bg2:#fef3c7; --bg3:#ffe4e6; --tri:linear-gradient(90deg,#fb7185 0%, #f59e0b 50%, #a78bfa 100%);
    }

    [data-theme="dark"]{
      --fg:#e5eefc; --muted:#9fb1c9; --line:#223043; --accent:#5eead4; --accent-ink:#7dd3fc;
      --ok:#34d399; --ok-bright:#34d399; --time:#c4b5fd; --loc:#67e8f9;
      --bg1:#06131f; --bg2:#0a1c2c; --bg3:#0e1f3b; --card:#0f1a2aee; --card-tint:#0b1422;
      --warn:#fbbf24; --err:#f87171; --shadow-strong: 0 20px 40px rgba(0,0,0,.45);
      --shadow-soft: 0 8px 20px rgba(0,0,0,.35); --card-bg-plain:#0f172acc; --table-row:#0c1423;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; color:var(--fg);
      background:
        radial-gradient(1200px 700px at 15% 0%, var(--bg1) 0%, transparent 60%),
        radial-gradient(1300px 800px at 90% 20%, var(--bg2) 0%, transparent 55%),
        radial-gradient(900px 600px at 50% 110%, var(--bg3) 0%, transparent 50%),
        linear-gradient(160deg,#f8fafc 0%, #eff6ff 40%, #f0f9ff 100%);
      position:relative; min-height:100vh; display:flex; align-items:start; justify-content:center; padding:20px;
      transition: background .3s ease, color .2s ease;
    }
    body::after{ content:""; position:fixed; inset:0; pointer-events:none; background-image:var(--grain); mix-blend-mode:multiply; opacity:.22; }
    [data-theme="dark"]{
      background:
        radial-gradient(1400px 700px at 10% -10%, var(--bg1) 0%, transparent 60%),
        radial-gradient(1400px 800px at 100% 30%, var(--bg2) 0%, transparent 55%),
        radial-gradient(900px 600px at 50% 110%, var(--bg3) 0%, transparent 50%),
        linear-gradient(160deg,#05121a 0%, #0a1826 50%, #0c2036 100%);
    }

    .wrap{width:100%;max-width:1140px;display:flex;flex-direction:column;gap:18px}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:32px;height:32px;border-radius:8px;background-image:var(--tri)}
    .brand h1{font-size:22px;letter-spacing:.3px}

    .card{position:relative;background: linear-gradient(180deg,var(--card) 0%,var(--card-tint) 100%); backdrop-filter:blur(14px);
      border:1px solid var(--line); border-radius:16px; box-shadow:var(--shadow-strong); padding:18px 16px; transition:.2s}
    .section-title{font-size:18px;margin-bottom:8px}
    .byline{color:var(--accent-ink);font-weight:800;margin-left:4px}

    .grid{display:grid;gap:12px}
    .grid-2{grid-template-columns:1fr}
    @media(min-width:920px){ .grid-2{grid-template-columns:1.2fr .8fr} }

    label{color:var(--muted);font-size:13px}
    input,select,textarea{width:100%;height:44px;padding:10px 12px;border:1px solid var(--line);border-radius:12px;font-size:15px;background:#fff;outline:none;transition:.2s;color:#0b1220;}
    textarea{min-height:110px; height:auto}
    [data-theme="dark"] input,[data-theme="dark"] select,[data-theme="dark"] textarea{background:#0b1422; color:var(--fg); border-color:#1f2a38}
    input:focus,select:focus,textarea:focus{border-color:transparent; box-shadow:0 0 0 4px rgba(20,184,166,.2), inset 0 0 0 1.5px var(--accent)}
    .row{display:grid;gap:6px}
    .btns{display:flex;gap:10px;flex-wrap:wrap}

    button{height:42px;border-radius:12px;font-weight:800;letter-spacing:.2px;cursor:pointer;border:0;padding:0 14px;background-image:var(--tri);background-size:200% 100%;color:#fff;box-shadow:0 8px 20px rgba(11,18,32,.15);transition:.15s}
    button:hover{transform:translateY(-1px); background-position:right center; filter:saturate(1.05)}
    .btn-mini{height:34px;padding:0 10px;border-radius:10px;font-weight:700}
    .ghost{background:transparent; color:transparent; border:2px solid transparent; background-image:var(--tri); -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent; border-image: var(--tri) 1}
    .muted{color:var(--muted)} .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .small{font-size:12px;color:var(--muted)}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px;color:var(--fg);background:#fff}
    [data-theme="dark"] .pill{ background:#0b1422; }

    .msg{margin-top:10px;padding:10px;border-radius:12px;border:1px solid var(--line);background:#f8fafc;min-height:40px;white-space:pre-wrap;color:#0b1220}
    [data-theme="dark"] .msg{background:#0b1422; color:var(--fg); border-color:#1f2a38;}
    .msg-ok{border-color:var(--ok)!important;background:#ecfdf5!important}
    .msg-warn{border-color:var(--warn)!important;background:#fffbeb!important}
    .msg-err{border-color:var(--err)!important;background:#fef2f2!important}

    .table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
    table{width:100%;border-collapse:separate;border-spacing:0 8px;min-width:720px}
    thead th{text-align:left;font-size:12px;color:var(--muted);padding:0 10px;white-space:nowrap}
    tbody tr{background:var(--table-row);border:1px solid var(--line);border-radius:12px;overflow:hidden;box-shadow:0 4px 10px rgba(11,18,32,.05)}
    td{padding:10px;font-size:14px;vertical-align:middle;color:var(--fg)}
    .cell-name{ color: var(--ok-bright) !important; font-weight:700 !important; }
    .cell-content.ip{ color: var(--accent) !important; font-weight:700 !important; }
    .cell-content.host{ color: var(--ok-bright) !important; font-weight:700 !important; }

    .status{ display:grid; gap:10px; grid-template-columns:1fr 1fr 1fr }
    .pillstat{ display:flex; flex-direction:column; gap:2px; border:1px solid var(--line); background:var(--table-row); border-radius:14px; padding:10px 12px; min-height:56px; justify-content:center }
    .pillstat .k{font-size:12px;color:var(--muted)} .pillstat .v{font-weight:700}
    #serverTime{ color: var(--time) } #yourIp{ color: var(--accent) } #yourLoc{ color: var(--loc) }

    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#fff}
    [data-theme="dark"] .badge{background:#0b1422}

    .theme-fab{ position:fixed; right:18px; bottom:18px; z-index:9999; width:54px; height:54px; border-radius:999px; display:inline-flex; align-items:center; justify-content:center; background-image:var(--tri); background-size:200% 100%; color:#fff; border:0; box-shadow:0 14px 30px rgba(59,130,246,.35); cursor:pointer; transition:.15s }
    .theme-fab:hover{ transform: translateY(-2px); filter:saturate(1.05); background-position:right center }
    .icon{ width:22px; height:22px }

    .footer{ text-align:center; font-size:13px; color:var(--fg); background:var(--card-bg-plain); border:1px solid var(--line); border-radius:12px; padding:10px; box-shadow:var(--shadow-soft) }

    /* Simple modal */
    .modal{position:fixed;inset:0;display:none;background:rgba(0,0,0,.45);align-items:center;justify-content:center;z-index:9998}
    .modal .box{background:var(--card-bg-plain);border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow-strong);max-width:680px;width:92%;padding:16px}
    .modal.open{display:flex}

  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>JVPN VIP DNS CREATOR <span class="byline">Power By : Jue Htet</span></h1>
      </div>
      <div class="toolbar">
        <select id="langSel" title="Language">
          <option value="my">·Äô·Äº·Äî·Ä∫·Äô·Ä¨</option>
          <option value="en">English</option>
        </select>
        <select id="themePreset" title="Theme preset">
          <option value="cyan">Cyan/Indigo</option>
          <option value="emerald">Emerald</option>
          <option value="sunset">Sunset</option>
        </select>
        <button id="themeToggle" class="btn-mini">Dark/Light</button>
        <span id="envBadge" class="badge">ENV: <b>Prod</b> ‚Ä¢ <span id="latency">‚Äî</span></span>
        <label class="btn-mini ghost" style="padding:6px 10px;display:flex;gap:6px;align-items:center">
          <input id="adminMode" type="checkbox"/> Admin
        </label>
        <button id="settingsBtn" class="btn-mini">Settings</button>
        <button id="helpBtn" class="btn-mini">?</button>
      </div>
    </div>

    <!-- Status -->
    <div class="card">
      <div class="status">
        <div class="pillstat"><div class="k">Server Time</div><div id="serverTime" class="v mono">‚Äî</div></div>
        <div class="pillstat"><div class="k">Your IP</div><div id="yourIp" class="v mono">‚Äî</div></div>
        <div class="pillstat"><div class="k">Location</div><div id="yourLoc" class="v">‚Äî</div></div>
      </div>
    </div>

    <!-- Main grid -->
    <div class="grid grid-2">
      <!-- Left: Creator -->
      <div class="card">
        <div class="section-title">Create / Update DNS</div>
        <div class="small" style="margin-bottom:8px">Tip: <span class="mono">Ctrl + Enter</span> = Submit, <span class="mono">/</span> = Search, <span class="mono">?</span> = Help</div>

        <!-- Templates -->
        <div class="row">
          <label>Templates (optional)</label>
          <div class="btns">
            <button class="btn-mini" data-tpl="A:app:203.0.113.10">A ‚Ä¢ app ‚Üí 203.0.113.10</button>
            <button class="btn-mini" data-tpl='CNAME:cdn:target.example.com'>CNAME ‚Ä¢ cdn ‚Üí target.example.com</button>
            <button class="btn-mini" data-tpl='SRV:_xmpp._tcp:10 5 5222 xmpp.example.com'>SRV ‚Ä¢ _xmpp._tcp</button>
            <button class="btn-mini" data-tpl='HTTPS:1 . alpn="h2,h3", port="443"'>HTTPS ‚Ä¢ h2/h3</button>
            <button class="btn-mini" data-tpl='SVCB:1 . alpn="h3" ipv4hint="1.2.3.4"'>SVCB ‚Ä¢ h3</button>
            <button class="btn-mini" id="clearTpl">Clear</button>
          </div>
        </div>

        <form id="dnsForm" autocomplete="off">
          <div class="row">
            <label for="zoneSel">Zone</label>
            <select id="zoneSel" title="Select domain zone"></select>
          </div>

          <div class="row">
            <label for="type">Type</label>
            <select id="type" required title="Record type">
              <option value="A">A</option><option value="AAAA">AAAA</option>
              <option value="CAA">CAA</option><option value="CERT">CERT</option>
              <option value="CNAME">CNAME</option><option value="DNSKEY">DNSKEY</option>
              <option value="DS">DS</option><option value="HTTPS">HTTPS</option>
              <option value="LOC">LOC</option><option value="MX">MX</option>
              <option value="NAPTR">NAPTR</option><option value="NS">NS</option>
              <option value="OPENPGPKEY">OPENPGPKEY</option><option value="PTR">PTR</option>
              <option value="SMIMEA">SMIMEA</option><option value="SRV">SRV</option>
              <option value="SSHFP">SSHFP</option><option value="SVCB">SVCB</option>
              <option value="TLSA">TLSA</option><option value="TXT">TXT</option><option value="URI">URI</option>
            </select>
          </div>

          <div class="row">
            <label for="host">Host</label>
            <input id="host" type="text" placeholder="sub (or sub.jvpnapp.site)" title="Enter sub or FQDN" required />
            <div class="small" id="hostHint"></div>
          </div>

          <!-- Type-aware inputs -->
          <div id="typeAware" class="row" style="display:none"></div>

          <div class="row" id="genericContentRow">
            <label id="contentLabel" for="content">IPv4 Address</label>
            <input id="content" type="text" placeholder="e.g. 203.0.113.10" />
          </div>

          <div class="row" id="prioRow" style="display:none">
            <label for="priority">Priority (MX/SRV)</label>
            <input id="priority" type="number" min="0" max="65535" placeholder="10 (MX only)" />
          </div>

          <div class="row">
            <label for="ttl">TTL</label>
            <select id="ttl">
              <option value="1" selected>Auto</option>
              <option value="60">60</option><option value="120">120</option>
              <option value="300">300</option><option value="600">600</option>
              <option value="1800">1800</option><option value="3600">3600</option>
            </select>
          </div>

          <div class="row" id="proxiedRow">
            <label for="proxied">Proxy through Cloudflare (A/AAAA/CNAME)</label>
            <div>
              <label class="switch" aria-label="Proxy through Cloudflare">
                <!-- default OFF per auto-rule -->
                <input id="proxied" type="checkbox" />
                <span class="slider" aria-hidden="true"></span>
              </label>
              <span class="pill">A / AAAA / CNAME only</span>
              <div class="small">DNS ONLY ·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ ·ÄÅ·Äú·ÄØ·Äê·Ä∫·ÄÄ·Ä≠·ÄØ ·Äï·Ä≠·Äê·Ä∫·Äï·Ä±·Ä∏·Äï·Ä´·Åã</div>
            </div>
          </div>

          <div class="btns">
            <button type="submit" id="submitBtn" title="Create/Update (Ctrl+Enter)">Add / Update</button>
            <button type="button" id="resetBtn">Reset</button>
            <button type="button" id="copyBtn" class="ghost">Copy Payload</button>
            <button type="button" id="shareBtn" class="ghost">Share Link</button>
            <button type="button" id="undoBtn" class="ghost">Undo Last</button>
          </div>

          <div id="msg" class="msg"></div>

          <details style="margin-top:8px">
            <summary><b>JSON Preview</b></summary>
            <pre id="jsonPreview" class="small mono" style="margin-top:8px;white-space:pre-wrap"></pre>
          </details>

          <div class="small" style="margin-top:8px">
            Host ·ÄÄ·Ä≠·ÄØ short (e.g. <span class="mono">app</span>) ·Äõ·Ä≠·ÄØ·ÄÄ·Ä∫·Äõ·ÄÑ·Ä∫
            <span class="mono" id="appendPreview">app.jvpnapp.site</span> ·Äú·Ä≠·ÄØ append ·Äú·ÄØ·Äï·Ä∫·Äï·Ä±·Ä∏·Äô·Äö·Ä∫·Åã
          </div>
        </form>
      </div>

      <!-- Right: Tools -->
      <div class="grid">
        <!-- Lookup / Propagation -->
        <div class="card">
          <div class="section-title">Lookup & Propagation</div>
          <div class="row">
            <label for="lookupHost">Host</label>
            <input id="lookupHost" type="text" placeholder="sub (or FQDN)" />
          </div>
          <div class="btns" style="margin-top:8px">
            <button type="button" id="lookupBtn">Lookup</button>
            <button type="button" id="propBtn" class="ghost" title="Cloudflare + Google">Propagation</button>
            <button type="button" id="healthBtn" class="ghost" title="HTTP/HTTPS probe">Health</button>
            <button type="button" id="lookupReset">Clear</button>
          </div>
          <div id="lookupMsg" class="msg"></div>
        </div>

        <!-- Bulk Import -->
        <div class="card">
          <div class="section-title">Bulk Import (CSV / JSON)</div>
          <div class="row">
            <label for="bulkInput">Paste records</label>
            <textarea id="bulkInput" placeholder='CSV: type,name,content,ttl,proxied,priority
TXT,_acme-challenge.example.com,"v=spf1 include:_spf.example ~all",300,false
JSON: [{"type":"A","name":"app.jvpnapp.site","content":"203.0.113.10","ttl":300,"proxied":false}]'></textarea>
          </div>
          <div class="btns">
            <button type="button" id="bulkPreview">Preview</button>
            <button type="button" id="bulkApply" class="ghost">Apply All</button>
          </div>
          <div id="bulkMsg" class="msg small"></div>
        </div>

        <!-- Search / Manage -->
        <div class="card">
          <div class="section-title">Cloudflare DNS (Search / Edit / Delete)</div>
          <div class="row"><label for="cfName">Search</label><input id="cfName" placeholder="name or content (partial)"/></div>
          <div class="row">
            <label for="cfType">Type</label>
            <select id="cfType">
              <option value="">(Any)</option>
              <option>A</option><option>AAAA</option><option>CAA</option><option>CERT</option>
              <option>CNAME</option><option>DNSKEY</option><option>DS</option><option>HTTPS</option>
              <option>LOC</option><option>MX</option><option>NAPTR</option><option>NS</option>
              <option>OPENPGPKEY</option><option>PTR</option><option>SMIMEA</option><option>SRV</option>
              <option>SSHFP</option><option>SVCB</option><option>TLSA</option><option>TXT</option><option>URI</option>
            </select>
          </div>
          <div class="btns">
            <button type="button" id="cfSearch">Search</button>
            <button type="button" id="cfClear">Clear</button>
            <button type="button" class="ghost btn-mini" id="prevPage">Prev</button>
            <button type="button" class="ghost btn-mini" id="nextPage">Next</button>
          </div>
          <div id="searchMsg" class="small">Results are queried directly from Cloudflare.</div>
          <div class="table-wrap" style="margin-top:8px">
            <table class="table" aria-label="Cloudflare search results">
              <thead><tr><th>Type</th><th>Name</th><th>Content</th><th>TTL</th><th>Proxy</th><th>Actions</th></tr></thead>
              <tbody id="cfBody"></tbody>
            </table>
          </div>
        </div>

        <!-- Footer -->
        <div class="footer">Admin : <b>Jue Htet</b> ·Äô·Äæ·ÄÖ·Ä±·Äê·Äî·Ä¨·Äñ·Äº·ÄÑ·Ä∑·Ä∫ ·Äï·Äº·ÄØ·Äú·ÄØ·Äï·Ä∫·Äï·Ä±·Ä∏·Äë·Ä¨·Ä∏·Äï·Ä´·Äû·Ää·Ä∫·Åã</div>
      </div>
    </div>
  </div>

  <!-- Settings modal -->
  <div id="settingsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <div class="box">
      <h3 id="settingsTitle">Settings</h3>
      <div class="row" style="margin-top:10px">
        <label for="rootInput">Default Root (zone)</label>
        <input id="rootInput" placeholder="e.g. jvpnapp.site"/>
      </div>
      <div class="row">
        <label for="apiInput">API Base (Worker)</label>
        <input id="apiInput" placeholder="https://jvpnvip-app.jvpnapp.workers.dev"/>
      </div>
      <div class="row">
        <label for="zonesInput">Zone list (comma)</label>
        <input id="zonesInput" placeholder="jvpnapp.site, api.jvpnapp.site"/>
      </div>
      <div class="btns" style="margin-top:12px">
        <button id="saveSettings">Save</button>
        <button id="closeSettings" class="ghost">Close</button>
      </div>
    </div>
  </div>

  <!-- Help modal -->
  <div id="helpModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
    <div class="box">
      <h3 id="helpTitle">Keyboard & Tips</h3>
      <div class="small" style="margin-top:10px; line-height:1.6">
        <b>Shortcuts:</b> Ctrl/Cmd+Enter = Submit ‚Ä¢ / = Focus Search ‚Ä¢ ? = Help<br/>
        <b>SRV</b> ‚Üí Priority/Weight/Port/Target inputs ‚Ä¢ <b>SVCB/HTTPS</b> ‚Üí param builder (alpn, port, ipv4hint, echconfig ‚Ä¶)<br/>
        Proxy is valid for A/AAAA/CNAME only. DNS ONLY ·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ switch ·ÄÄ·Ä≠·ÄØ ·Äï·Ä≠·Äê·Ä∫·Äë·Ä¨·Ä∏·Äï·Ä´·Åã
      </div>
      <div class="btns" style="margin-top:12px">
        <button id="closeHelp" class="ghost">Close</button>
      </div>
    </div>
  </div>

  <!-- Theme FAB -->
  <button id="fabToggle" class="theme-fab" title="Dark/Light">
    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
    </svg>
  </button>

  <script>
    /* =========================
       Config / i18n / Theme
       ========================= */
    const DEFAULT_CONFIG = {
      ROOT: "jvpnapp.site",
      API_BASE: "https://jvpnvip-app.jvpnapp.workers.dev",
      ZONES: ["jvpnapp.site"]
    };
    let CFG = loadConfig();

    function loadConfig(){
      try{
        const j = JSON.parse(localStorage.getItem("cfg")||"{}");
        return Object.assign({}, DEFAULT_CONFIG, j);
      }catch(e){ return {...DEFAULT_CONFIG}; }
    }
    function saveConfig(){
      localStorage.setItem("cfg", JSON.stringify(CFG));
      applyZones();
      updateAppendPreview();
    }

    const STR = {
      my:{
        processing:"·Äú·ÄØ·Äï·Ä∫·Äî·Ä±·Äï·Ä´·Äû·Ää·Ä∫‚Ä¶", done:"·Äï·Äº·ÄÆ·Ä∏·Äï·Äº·ÄÆ ‚úÖ", err:"·Ä°·Äô·Äæ·Ä¨·Ä∏·Äñ·Äº·ÄÖ·Ä∫·Äû·Ää·Ä∫ ‚ùå",
        hostReq:"‚ùå Host ·Äú·Ä≠·ÄØ·Ä°·Äï·Ä∫",
        hostUnder:"‚ùå Host ·Äû·Ää·Ä∫ zone ·Ä°·Ä±·Ä¨·ÄÄ·Ä∫·Äê·ÄΩ·ÄÑ·Ä∫ ·Äñ·Äº·ÄÖ·Ä∫·Äõ·Äô·Ää·Ä∫",
        contentReq:"‚ùå Content ·Äú·Ä≠·ÄØ·Ä°·Äï·Ä∫",
        updated:"Update ·Äï·Äº·ÄÆ·Ä∏ ‚úÖ",
        deleted:"·Äñ·Äª·ÄÄ·Ä∫·Äï·Äº·ÄÆ·Ä∏ ‚úÖ",
        loaded:"Loaded into form. ·Äï·Äº·ÄÑ·Ä∫·Äï·Äº·ÄÆ·Ä∏ Add/Update ·Äî·Äæ·Ä≠·Äï·Ä∫·Äï·Ä´·Åã",
        noAns:"·Ä°·Äñ·Äº·Ä± ·Äô·Äõ·Äï·Ä´",
        searching:"·Äõ·Äæ·Ä¨·Äî·Ä±·Äû·Ää·Ä∫‚Ä¶",
      },
      en:{
        processing:"Processing‚Ä¶", done:"Done ‚úÖ", err:"Error ‚ùå",
        hostReq:"‚ùå Host required",
        hostUnder:"‚ùå Host must be under zone",
        contentReq:"‚ùå Content required",
        updated:"Updated ‚úÖ",
        deleted:"Deleted ‚úÖ",
        loaded:"Loaded into form. Edit and click Add/Update.",
        noAns:"No answers",
        searching:"Searching‚Ä¶",
      }
    };
    function t(k){ const lang = localStorage.getItem("lang")||"my"; return (STR[lang]&&STR[lang][k])||k; }

    // Theme + preset
    (function initUI(){
      const root = document.documentElement;
      const savedTheme = localStorage.getItem("theme");
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      root.setAttribute("data-theme", savedTheme || (prefersDark ? "dark" : "light"));
      const preset = localStorage.getItem("preset") || "cyan";
      root.setAttribute("data-preset", preset);
      document.getElementById("themePreset").value = preset;
      document.getElementById("langSel").value = localStorage.getItem("lang")||"my";
      document.getElementById("adminMode").checked = localStorage.getItem("admin")==="1";
    })();
    document.getElementById("themeToggle").onclick = toggleTheme;
    document.getElementById("fabToggle").onclick = toggleTheme;
    function toggleTheme(){
      const root = document.documentElement;
      const cur = root.getAttribute("data-theme") || "light";
      const next = (cur === "light") ? "dark" : "light";
      root.setAttribute("data-theme", next);
      localStorage.setItem("theme", next);
    }
    document.getElementById("themePreset").onchange = (e)=>{
      document.documentElement.setAttribute("data-preset", e.target.value);
      localStorage.setItem("preset", e.target.value);
    };
    document.getElementById("langSel").onchange = (e)=>{ localStorage.setItem("lang", e.target.value); location.reload(); };
    document.getElementById("adminMode").onchange = (e)=>{ localStorage.setItem("admin", e.target.checked?"1":"0"); };

    // Settings modal
    const settingsModal = document.getElementById("settingsModal");
    document.getElementById("settingsBtn").onclick = ()=>{ openModal(settingsModal); fillSettings(); };
    document.getElementById("closeSettings").onclick = ()=> closeModal(settingsModal);
    document.getElementById("saveSettings").onclick = ()=>{
      CFG.ROOT = document.getElementById("rootInput").value.trim() || CFG.ROOT;
      CFG.API_BASE = document.getElementById("apiInput").value.trim() || CFG.API_BASE;
      CFG.ZONES = (document.getElementById("zonesInput").value || CFG.ROOT).split(",").map(s=>s.trim()).filter(Boolean);
      saveConfig(); closeModal(settingsModal);
    };
    function fillSettings(){
      document.getElementById("rootInput").value = CFG.ROOT;
      document.getElementById("apiInput").value = CFG.API_BASE;
      document.getElementById("zonesInput").value = CFG.ZONES.join(", ");
    }
    function openModal(m){ m.classList.add("open"); }
    function closeModal(m){ m.classList.remove("open"); }

    // Help modal
    const helpModal = document.getElementById("helpModal");
    document.getElementById("helpBtn").onclick = ()=> openModal(helpModal);
    document.getElementById("closeHelp").onclick = ()=> closeModal(helpModal);

    /* =========================
       Elements & State
       ========================= */
    const el = {
      zoneSel: id("zoneSel"), type: id("type"), host: id("host"), content: id("content"),
      prioRow: id("prioRow"), priority: id("priority"), proxiedRow: id("proxiedRow"), proxied: id("proxied"),
      ttl: id("ttl"), msg: id("msg"), jsonPreview: id("jsonPreview"),
      appendPreview: id("appendPreview"), hostHint: id("hostHint"),
      // lookup
      lookupHost: id("lookupHost"), lookupMsg: id("lookupMsg"),
      // search/manage
      cfName: id("cfName"), cfType: id("cfType"), cfBody: id("cfBody"), searchMsg: id("searchMsg"),
      // bulk
      bulkInput: id("bulkInput"), bulkMsg: id("bulkMsg"),
      // others
      latency: id("latency")
    };
    function id(s){ return document.getElementById(s); }

    // Zones
    function applyZones(){
      el.zoneSel.innerHTML = "";
      (CFG.ZONES||[CFG.ROOT]).forEach(z=>{
        const opt = document.createElement("option"); opt.value = z; opt.textContent = z;
        if(z===CFG.ROOT) opt.selected = true;
        el.zoneSel.appendChild(opt);
      });
      updateAppendPreview();
    }
    applyZones();
    el.zoneSel.onchange = ()=>{ CFG.ROOT = el.zoneSel.value; saveConfig(); };

    // Append preview
    function updateAppendPreview(){
      const s = (el.host.value||"app").replace(/\s+/g,"") || "app";
      el.appendPreview.textContent = `${s}.${CFG.ROOT}`;
      el.host.placeholder = `sub (or sub.${CFG.ROOT})`;
    }
    el.host.addEventListener("input", updateAppendPreview);

    /* =========================
       Status section (IP/time/loc)
       ========================= */
    const serverTimeEl = id("serverTime"), yourIpEl=id("yourIp"), yourLocEl=id("yourLoc");
    async function fetchJSON(url, opt){ const r = await fetch(url, opt); if(!r.ok) throw new Error(r.status); return r.json(); }
    async function loadFromCFTrace(){
      try{
        const r = await fetch("https://1.1.1.1/cdn-cgi/trace", {cache:"no-store"}); const t = await r.text();
        const map = Object.fromEntries(t.trim().split("\n").map(l=>l.split("=")));
        if(map.ts){
          let ms = Number(map.ts) * 1000; const tzStr = Intl.DateTimeFormat().resolvedOptions().timeZone || "Local";
          const tick = ()=>{ serverTimeEl.textContent = new Date(ms).toLocaleString(undefined,{year:"numeric",month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}) + ` (${tzStr})`; ms+=1000; };
          tick(); setInterval(tick,1000);
        } else serverTimeEl.textContent = "Unavailable";
        if(map.ip) yourIpEl.textContent = map.ip;
        if(!yourLocEl.textContent || yourLocEl.textContent==="‚Äî" || yourLocEl.textContent==="Unavailable"){ yourLocEl.textContent = map.loc || "Unavailable"; }
      }catch(e){ if(!serverTimeEl.textContent || serverTimeEl.textContent==="‚Äî") serverTimeEl.textContent = "Unavailable"; }
    }
    async function loadStatus(){
      let haveWT = false;
      try{
        const t = await fetchJSON("https://worldtimeapi.org/api/ip");
        const dt = new Date(t.datetime); let base = dt.getTime();
        const tick = ()=>{ serverTimeEl.textContent = new Date(base).toLocaleString(undefined,{year:"numeric",month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}) + ` (${t.timezone})`; base+=1000; };
        tick(); setInterval(tick,1000); if(t.client_ip) yourIpEl.textContent=t.client_ip; haveWT=true;
      }catch(e){}
      try{
        const a = await fetchJSON("https://ipapi.co/json/"); if(a.ip) yourIpEl.textContent = a.ip;
        const loc=[a.city,a.region,a.country_name].filter(Boolean).join(", "); yourLocEl.textContent = loc || "‚Äî";
      }catch(e){
        try{
          const b = await fetchJSON("https://ipwho.is/"); if(b.ip) yourIpEl.textContent=b.ip;
          const loc=[b.city,b.region,b.country].filter(Boolean).join(", "); yourLocEl.textContent = loc || "‚Äî";
        }catch(e2){
          try{ const c = await fetchJSON("https://api.ipify.org?format=json"); if(c.ip) yourIpEl.textContent=c.ip; }catch(e3){}
          if(!yourLocEl.textContent || yourLocEl.textContent==="‚Äî") yourLocEl.textContent="Unavailable";
        }
      }
      if(!haveWT) await loadFromCFTrace();
    }
    loadStatus();

    /* =========================
       Utils (validation, highlight)
       ========================= */
    const ipV4Test = /^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/i;
    const ipV6Test = /^(?:[A-Fa-f0-9]{1,4}:){1,7}[A-Fa-f0-9]{1,4}$/;
    const hostMatch = /\b(?=.{1,253}\b)(?:[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?)(?:\.(?:[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?))+\.?\b/gi;
    function isIP(s){ s=String(s||"").trim(); return ipV4Test.test(s)||ipV6Test.test(s); }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
    function escapeHtmlAttr(s){ return String(s).replace(/"/g,'&quot;'); }
    function highlightInline(text){
      const ipV4Match=/\b(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\b/g;
      const ipV6Match=/\b(?:[A-Fa-f0-9]{1,4}:){1,7}[A-Fa-f0-9]{1,4}\b/g;
      let out = text.replace(ipV4Match, m=>`<span class="cell-content ip mono">${m}</span>`);
      out = out.replace(ipV6Match, m=>`<span class="cell-content ip mono">${m}</span>`);
      out = out.replace(hostMatch, m=>{
        if(isIP(m)) return m;
        return `<span class="cell-content host mono">${m}</span>`;
      });
      return out;
    }
    function show(kind, text, el=el.msg){ el.innerHTML = highlightInline(String(text)); el.className="msg " + (kind==="ok"?"msg-ok":kind==="warn"?"msg-warn":"msg-err"); }

    // Retry wrapper with latency measure
    async function apiFetch(url, opt={}, retries=2){
      const t0 = performance.now();
      try{
        const r = await fetch(url, opt);
        const ms = Math.round(performance.now()-t0);
        el.latency.textContent = ms+"ms";
        if(r.status>=500 || r.status===429){
          if(retries>0){ await new Promise(res=>setTimeout(res, 400*(3-retries))); return apiFetch(url,opt,retries-1); }
        }
        return r;
      }catch(e){
        if(retries>0){ await new Promise(res=>setTimeout(res, 500)); return apiFetch(url,opt,retries-1); }
        throw e;
      }
    }

    /* =========================
       Type-aware inputs builder
       ========================= */
    const typeAware = document.getElementById("typeAware");
    function renderTypeAware(){
      const t=el.type.value;
      typeAware.innerHTML=""; typeAware.style.display="none";
      el.prioRow.style.display = (t==="MX"||t==="SRV") ? "grid":"none";
      el.proxiedRow.style.display = (["A","AAAA","CNAME"].includes(t)) ? "grid":"none";
      el.proxied.checked = false; // auto-rule: default DNS only

      const placeholders = {
        "A":["IPv4 Address","e.g. 203.0.113.10"], "AAAA":["IPv6 Address","e.g. 2001:db8::1"],
        "CNAME":["Target Hostname","e.g. target.example.com"], "TXT":["TXT Value",'e.g. v=spf1 include:_spf.example ~all'],
        "MX":["Mail Server","e.g. mail.example.com"], "NS":["Nameserver Host","e.g. ns1.example.com"],
        "CAA":["CAA Value",'e.g. 0 issue "letsencrypt.org"'],
        "HTTPS":["HTTPS Value",'e.g. 1 . alpn="h2", port="443"'],
        "DNSKEY":["DNSKEY Value","e.g. 257 3 13 AwEAAc..."], "DS":["DS Value","e.g. 2371 13 2 49FD46..."],
        "CERT":["CERT Value","e.g. 1 0 0 MIICIjANBgkqh..."], "LOC":["LOC Value","e.g. 37 46 45.000 N 122 25 09.000 W 1m 100m"],
        "NAPTR":["NAPTR Value",'e.g. 100 10 "U" "E2U+sip" "!^.*$!sip:info@example.com!" .'],
        "OPENPGPKEY":["OPENPGPKEY","Paste armored key data"], "PTR":["PTR Host","e.g. host.example.com"],
        "SMIMEA":["SMIMEA Value","e.g. 3 0 1 8A9A7054..."], "SRV":["SRV Value","e.g. 10 5 5222 xmpp.example.com"],
        "SSHFP":["SSHFP Value","e.g. 4 2 123456789abcdef..."], "SVCB":["SVCB Value",'e.g. 1 . alpn="h3", port="443"'],
        "TLSA":["TLSA Value","e.g. 3 1 1 d2abde240d..."], "URI":["URI Value",'e.g. 10 1 "https://service.example.com"']
      };
      const p = placeholders[t] || ["Content","Enter value"];
      document.getElementById("contentLabel").textContent = p[0];
      el.content.placeholder = p[1];

      // SRV fields
      if(t==="SRV"){
        typeAware.style.display="grid";
        typeAware.innerHTML = `
          <div class="row"><label>SRV ‚Ä¢ Weight</label><input id="srvWeight" type="number" min="0" placeholder="5"/></div>
          <div class="row"><label>SRV ‚Ä¢ Port</label><input id="srvPort" type="number" min="1" max="65535" placeholder="5222"/></div>
          <div class="row"><label>SRV ‚Ä¢ Target</label><input id="srvTarget" placeholder="xmpp.example.com"/></div>
        `;
        el.priority.placeholder="10";
        el.prioRow.style.display="grid";
        el.content.placeholder="(auto from SRV fields)"; el.content.value="";
      }

      // SVCB/HTTPS param builder
      if(t==="SVCB" || t==="HTTPS"){
        typeAware.style.display="grid";
        typeAware.innerHTML = `
          <div class="row"><label>Priority</label><input id="svcbPri" type="number" min="0" value="1"/></div>
          <div class="row"><label>Target</label><input id="svcbTarget" placeholder="." title="Use . for alias"/></div>
          <div class="row"><label>Params</label>
            <div class="btns">
              <button type="button" class="btn-mini" data-kv='alpn="h2,h3"'>+ alpn</button>
              <button type="button" class="btn-mini" data-kv='port="443"'>+ port</button>
              <button type="button" class="btn-mini" data-kv='ipv4hint="1.2.3.4"'>+ ipv4hint</button>
              <button type="button" class="btn-mini" data-kv='ech="BASE64..."'>+ ech</button>
              <button type="button" class="btn-mini" id="clearParams">Clear</button>
            </div>
            <textarea id="svcbParams" class="mono" placeholder='alpn="h3", port="443"'></textarea>
          </div>
        `;
        el.content.placeholder='(auto from SVCB/HTTPS fields)';
        el.content.value="";
        typeAware.querySelectorAll("[data-kv]").forEach(b=> b.onclick = ()=>{ const ta=id("svcbParams"); ta.value = (ta.value?ta.value+", ":"")+b.getAttribute("data-kv"); });
        id("clearParams").onclick = ()=> id("svcbParams").value="";
      }
    }
    el.type.addEventListener("change", renderTypeAware);
    renderTypeAware();

    /* =========================
       Templates
       ========================= */
    document.querySelectorAll("[data-tpl]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const [t, host, rest] = btn.getAttribute("data-tpl").split(":");
        el.type.value = t; renderTypeAware();
        if(host) el.host.value = host;
        if(t==="SRV"){ el.priority.value=10; id("srvWeight").value=5; id("srvPort").value=5222; id("srvTarget").value="xmpp.example.com"; }
        else if(t==="SVCB"||t==="HTTPS"){ id("svcbPri").value=1; id("svcbTarget").value="."; id("svcbParams").value=rest||''; }
        else { el.content.value = rest||""; }
        updateAppendPreview();
      });
    });
    document.getElementById("clearTpl").onclick = ()=>{
      el.type.value="A"; renderTypeAware();
      el.host.value=""; el.content.value=""; el.priority.value=""; updateAppendPreview();
    };

    /* =========================
       Existing name auto-open
       ========================= */
    let autoOpenTimer=null;
    el.host.addEventListener("blur", tryAutoOpen);
    el.host.addEventListener("input", ()=>{ clearTimeout(autoOpenTimer); autoOpenTimer=setTimeout(tryAutoOpen, 700); });
    async function tryAutoOpen(){
      const name = normalizeHost(el.host.value);
      if(!name) return;
      const url = buildAPI("/dns?name="+encodeURIComponent(name)+"&per_page=1");
      try{
        const r = await apiFetch(url, {method:"GET"}); const data = await r.json();
        const rows = data.result||[];
        if(rows.length){ loadRowIntoForm(rows[0]); show("ok", t("loaded")); window.scrollTo({top:0,behavior:"smooth"}); }
      }catch(e){}
    }

    /* =========================
       Normalize host
       ========================= */
    function normalizeHost(raw){
      const v=(raw||"").trim().replace(/\s+/g,"");
      if(!v)return"";
      const ROOT = CFG.ROOT;
      if(v===ROOT||v.endsWith("."+ROOT))return v.toLowerCase();
      if(v.includes(".")) return v.toLowerCase();
      return (v+"."+ROOT).toLowerCase();
    }

    /* =========================
       Submit (Create/Update)
       ========================= */
    document.getElementById("dnsForm").addEventListener("submit", onSubmit);
    document.addEventListener("keydown", (e)=>{
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==="enter"){ e.preventDefault(); id("submitBtn").click(); }
      if(e.key==="/"){ e.preventDefault(); el.cfName.focus(); }
      if(e.key==="?"){ e.preventDefault(); openModal(helpModal); }
    });

    function buildAPI(path){ return (CFG.API_BASE.replace(/\/+$/,"") + path); }

    function collectPayload(){
      const type = el.type.value.trim().toUpperCase();
      const name = normalizeHost(el.host.value);
      let content = el.content.value.trim();
      const ttl = parseInt(el.ttl.value,10)||300;
      let proxied = !!el.proxied.checked;

      // Type-aware compose
      if(type==="SRV"){
        const pr = parseInt(el.priority.value,10); const w=parseInt(id("srvWeight").value,10)||0; const port=parseInt(id("srvPort").value,10)||1; const tar=id("srvTarget").value.trim();
        content = `${w||0} ${w||0} ${port} ${tar}`; // (note: Cloudflare uses priority separately in UI, but many APIs accept a single content string; keep our priority field for payload)
        if(Number.isNaN(pr)){ return {error:"SRV priority required"}; }
      }
      if(type==="SVCB" || type==="HTTPS"){
        const pri = parseInt(id("svcbPri").value,10)||1; const tar = id("svcbTarget").value.trim()||"."; const params = (id("svcbParams").value||"").trim();
        content = `${pri} ${tar} ${params}`.trim();
      }

      // Auto-rules
      if(!["A","AAAA","CNAME"].includes(type)) proxied=false;

      // Validation basics
      if(!name) return {error:t("hostReq")};
      if(!(name===CFG.ROOT || name.endsWith("."+CFG.ROOT))) return {error:t("hostUnder")+" "+CFG.ROOT};
      if(!content && type!=="SRV" && type!=="SVCB" && type!=="HTTPS") return {error:t("contentReq")};

      // Advanced: simple pattern checks
      if(type==="A" && content && !ipV4Test.test(content)) return {error:"Invalid IPv4"};
      if(type==="AAAA" && content && !ipV6Test.test(content)) return {error:"Invalid IPv6"};
      if(type==="DS" && content && !/^\d+\s+\d+\s+\d+\s+[A-Fa-f0-9]+$/.test(content)) return {error:"DS must be: keytag alg digestType digest"};
      if(type==="DNSKEY" && content && !/^\d+\s+\d+\s+\d+\s+/.test(content)) return {error:"DNSKEY must be: flags proto alg key"};
      if(type==="TLSA" && content && !/^\d+\s+\d+\s+\d+\s+[A-Fa-f0-9]+$/.test(content)) return {error:"TLSA must be: usage selector mtype digest"};

      const payload = {type,name,content,ttl};
      if(type==="MX" || type==="SRV"){
        const p=parseInt(el.priority.value,10);
        if(Number.isNaN(p)) return {error: (type==="MX"?"MX":"SRV")+" priority required"};
        payload.priority=p;
      }
      if(["A","AAAA","CNAME"].includes(type)) payload.proxied=proxied;
      return {payload};
    }

    async function onSubmit(e){
      e.preventDefault();
      const {payload, error} = collectPayload();
      if(error){ show("err", error); return; }
      previewJSON(payload);

      show("warn", t("processing"));
      try{
        const res = await apiFetch(buildAPI("/dns"), {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload)});
        const data = await res.json();
        if(data.success){
          const r=data.record||data.result||{};
          pushHistory({action:data.action||"create", after:r, before:null});
          show("ok",`${t("done")} : ${(r.content||payload.content)} ‚Üí ${(r.name||payload.name)} (${data.action||'create'})`);
          await runSearch(); // refresh table
        }else{
          show("err","‚ùå "+(data.error||"Unknown"));
        }
      }catch(err){ show("err","‚ùå Network error: "+err.message); }
    }

    // JSON preview + copy/share
    function previewJSON(p){ el.jsonPreview.textContent = JSON.stringify(p, null, 2); }
    id("copyBtn").onclick = ()=>{ navigator.clipboard.writeText(el.jsonPreview.textContent||""); };
    id("shareBtn").onclick = ()=>{
      const q = new URLSearchParams({
        type:el.type.value, host:el.host.value, content:el.content.value, ttl:el.ttl.value, proxied:el.proxied.checked?"1":"0", priority:el.priority.value||""
      });
      const url = location.origin + location.pathname + "#"+q.toString();
      navigator.clipboard.writeText(url);
      show("ok","Share link copied: "+url);
    };
    // Load from shared link (hash)
    (function loadFromHash(){
      if(location.hash.length>1){
        const h = new URLSearchParams(location.hash.slice(1));
        if(h.get("type")){ el.type.value=h.get("type"); renderTypeAware(); }
        if(h.get("host")) el.host.value=h.get("host");
        if(h.get("content")) el.content.value=h.get("content");
        if(h.get("ttl")) el.ttl.value=h.get("ttl");
        if(h.get("priority")) el.priority.value=h.get("priority");
        el.proxied.checked = h.get("proxied")==="1";
        updateAppendPreview();
      }
    })();

    // Reset
    id("resetBtn").onclick = ()=>{ id("dnsForm").reset(); renderTypeAware(); el.msg.textContent=""; el.msg.className="msg"; updateAppendPreview(); };

    /* =========================
       Lookup / Propagation / Health
       ========================= */
    id("lookupReset").onclick = ()=>{ el.lookupHost.value=""; el.lookupMsg.textContent=""; el.lookupMsg.className="msg"; };
    id("lookupBtn").onclick = ()=> lookup();
    id("propBtn").onclick = ()=> propagation();
    id("healthBtn").onclick = ()=> healthCheck();

    async function doh(name,type){
      const url=`https://cloudflare-dns.com/dns-query?name=${encodeURIComponent(name)}&type=${type}`;
      const res=await fetch(url,{headers:{accept:"application/dns-json"}});
      if(!res.ok) throw new Error(`DoH ${type} failed (${res.status})`);
      return res.json();
    }
    async function dohGoogle(name,type){
      const url=`https://dns.google/resolve?name=${encodeURIComponent(name)}&type=${type}`;
      const r = await fetch(url); if(!r.ok) throw new Error("Google DoH failed "+r.status); return r.json();
    }
    function formatAnswers(ans=[]){ return ans?.filter(a=>a?.data).map(a=>a.data)||[]; }

    async function lookup(){
      const name=normalizeHost(el.lookupHost.value||el.host.value);
      if(!name){ show("err", t("hostReq"), el.lookupMsg); return; }
      show("warn","Looking up‚Ä¶",el.lookupMsg);
      try{
        const [a4,a6]=await Promise.allSettled([doh(name,"A"),doh(name,"AAAA")]);
        const v4=(a4.status==="fulfilled")?formatAnswers(a4.value?.Answer):[];
        const v6=(a6.status==="fulfilled")?formatAnswers(a6.value?.Answer):[];
        if(v4.length===0 && v6.length===0){ show("err",`${t("noAns")} (${name})`,el.lookupMsg); return; }
        const chunks=[];
        if(v4.length) chunks.push(`A (${v4.length}) ‚Üí ${v4.map(ip=>`<span class="cell-content ip mono">${ip}</span>`).join(", ")}`);
        if(v6.length) chunks.push(`AAAA (${v6.length}) ‚Üí ${v6.map(ip=>`<span class="cell-content ip mono">${ip}</span>`).join(", ")}`);
        el.lookupMsg.className="msg msg-ok";
        el.lookupMsg.innerHTML = `<span class="cell-content host mono">${name}</span>\n${chunks.join("\n")}`;
      }catch(err){ show("err","‚ùå Lookup error: "+err.message,el.lookupMsg); }
    }

    async function propagation(){
      const name=normalizeHost(el.lookupHost.value||el.host.value);
      if(!name){ show("err", t("hostReq"), el.lookupMsg); return; }
      show("warn","Checking propagation‚Ä¶",el.lookupMsg);
      try{
        const [cfA, ggA] = await Promise.all([
          doh(name,"A").catch(()=>({Answer:[]})),
          dohGoogle(name,"A").catch(()=>({Answer:[]}))
        ]);
        const cf = formatAnswers(cfA.Answer); const gg = (ggA.Answer||[]).map(a=>a.data).filter(Boolean);
        const union = Array.from(new Set([...cf,...gg]));
        el.lookupMsg.className="msg msg-ok";
        el.lookupMsg.innerHTML = `üå•Ô∏è Cloudflare A ‚Üí ${cf.map(i=>`<span class="cell-content ip mono">${i}</span>`).join(", ") || "‚Äî"}
\nüîé Google A ‚Üí ${gg.map(i=>`<span class="cell-content ip mono">${i}</span>`).join(", ") || "‚Äî"}
\n‚úÖ Union ‚Üí ${union.map(i=>`<span class="cell-content ip mono">${i}</span>`).join(", ") || "‚Äî"}`;
      }catch(err){ show("err","‚ùå Propagation error: "+err.message,el.lookupMsg); }
    }

    async function healthCheck(){
      const target = (isIP(el.content.value)? el.content.value : (normalizeHost(el.lookupHost.value||el.host.value)));
      if(!target){ show("err", t("hostReq"), el.lookupMsg); return; }
      el.lookupMsg.className="msg msg-warn"; el.lookupMsg.textContent="Probing http/https‚Ä¶ (may be blocked by CORS)";
      const results=[];
      async function probe(url){
        const ctrl = new AbortController(); const t = setTimeout(()=>ctrl.abort(), 4000);
        try{ const r = await fetch(url, {method:"HEAD", mode:"no-cors", signal:ctrl.signal}); clearTimeout(t); results.push(url+" ‚Ä¢ OK"); }
        catch(e){ clearTimeout(t); results.push(url+" ‚Ä¢ fail"); }
      }
      const host = isIP(target)? target : target.replace(/\.$/,'');
      await Promise.all([probe("http://"+host+"/"), probe("https://"+host+"/")]);
      el.lookupMsg.className="msg"; el.lookupMsg.innerHTML = results.map(r=>"- "+escapeHtml(r)).join("\n");
    }

    /* =========================
       Bulk Import
       ========================= */
    id("bulkPreview").onclick = ()=> bulkParse(false);
    id("bulkApply").onclick = ()=> bulkParse(true);
    function bulkParse(apply){
      const raw = el.bulkInput.value.trim(); if(!raw){ el.bulkMsg.className="msg msg-err"; el.bulkMsg.textContent="Paste CSV or JSON first"; return; }
      let items=[];
      if(raw.trim().startsWith("[")){ // JSON
        try{ items = JSON.parse(raw); }catch(e){ el.bulkMsg.className="msg msg-err"; el.bulkMsg.textContent="Invalid JSON"; return; }
      }else{
        // CSV lines
        items = raw.split(/\r?\n/).map(line=>{
          const parts = line.split(",").map(s=>s.trim());
          if(parts.length<3) return null;
          return {type:parts[0], name:parts[1], content:parts.slice(2).join(",").replace(/^"|"$/g,"")};
        }).filter(Boolean);
      }
      const preview = items.map((x,i)=>`${i+1}. ${x.type} ${x.name} ‚Üí ${x.content}`).join("\n");
      el.bulkMsg.className="msg"; el.bulkMsg.textContent = (apply?"Applying‚Ä¶\n":"Preview:\n")+preview;
      if(!apply) return;

      (async ()=>{
        let ok=0, fail=0;
        for(const it of items){
          try{
            const payload = Object.assign({ttl:300}, it);
            if(payload.name) payload.name = normalizeHost(payload.name);
            if(payload.type==="MX" && payload.priority==null) payload.priority=10;
            if(["A","AAAA","CNAME"].includes(payload.type) && payload.proxied==null) payload.proxied=false;
            const r = await apiFetch(buildAPI("/dns"), {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload)});
            const data = await r.json(); if(data.success){ ok++; pushHistory({action:data.action||"create", after:data.result||data.record, before:null}); } else fail++;
          }catch(e){ fail++; }
        }
        el.bulkMsg.className="msg msg-ok"; el.bulkMsg.textContent = `Done. OK=${ok}, Fail=${fail}`;
        runSearch();
      })();
    }

    /* =========================
       History / Undo (local)
       ========================= */
    function pushHistory(entry){
      const list = JSON.parse(localStorage.getItem("history")||"[]");
      list.unshift(Object.assign({ts:Date.now()}, entry));
      localStorage.setItem("history", JSON.stringify(list.slice(0,50)));
    }
    id("undoBtn").onclick = async ()=>{
      const list = JSON.parse(localStorage.getItem("history")||"[]");
      if(!list.length){ show("err","Nothing to undo"); return; }
      const last = list.shift(); localStorage.setItem("history", JSON.stringify(list));
      try{
        if(last.after && last.after.id){ // we created; delete it
          const r = await apiFetch(buildAPI("/dns/"+last.after.id), {method:"DELETE"});
          const d = await r.json(); if(!d.success) throw new Error(d.error||"Delete failed");
        } else if(last.before && last.before.id){ // we updated; revert by PUT back
          const payload = {type:last.before.type, name:last.before.name, content:last.before.content, ttl:last.before.ttl};
          if(["A","AAAA","CNAME"].includes(last.before.type)) payload.proxied=!!last.before.proxied;
          if(last.before.type==="MX" && last.before.priority!=null) payload.priority=last.before.priority;
          const r = await apiFetch(buildAPI("/dns/"+last.before.id), {method:"PUT", headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload)});
          const d = await r.json(); if(!d.success) throw new Error(d.error||"Revert failed");
        }
        show("ok","Undo complete");
        runSearch();
      }catch(e){ show("err","Undo failed: "+e.message); }
    };

    /* =========================
       Search / Manage
       ========================= */
    document.getElementById("cfClear").addEventListener("click",()=>{ el.cfName.value=""; el.cfType.value=""; page=1; runSearch(); });
    document.getElementById("cfSearch").addEventListener("click",()=>{ page=1; runSearch(); });
    document.getElementById("prevPage").addEventListener("click", ()=>{ if(page>1){ page--; runSearch(); }});
    document.getElementById("nextPage").addEventListener("click", ()=>{ page++; runSearch(); });

    let page=1;
    function classifyContent(val){ return isIP(val) ? 'ip' : 'host'; }

    async function runSearch(){
      const params=new URLSearchParams();
      if(el.cfName.value.trim()) params.set("name", el.cfName.value.trim());
      if(el.cfType.value) params.set("type", el.cfType.value);
      params.set("page", String(page)); params.set("per_page","50");
      el.searchMsg.textContent=t("searching"); el.searchMsg.className="small";

      try{
        const res=await apiFetch(buildAPI("/dns?"+params.toString()),{method:"GET"});
        const data=await res.json();
        if(!data.success) throw new Error(data.error||"Search failed");
        const rows=data.result||[];
        el.cfBody.innerHTML="";
        if(rows.length===0){
          el.cfBody.innerHTML=`<tr><td colspan="6" class="small">No records on this page.</td></tr>`;
        }else{
          for(const r of rows){
            const tr=document.createElement("tr");
            const contentClass = classifyContent(r.content||"");
            const contentHTML = contentClass==='ip'
              ? `<span class="cell-content ip mono">${escapeHtml(r.content||"")}</span>`
              : `<span class="cell-content host mono">${escapeHtml(r.content||"")}</span>`;
            const prox = (["A","AAAA","CNAME"].includes(r.type) && r.proxied)? "üü© proxied":"‚¨ú DNS only";
            const admin = (localStorage.getItem("admin")==="1");
            tr.innerHTML = `
              <td class="cell-type"><span class="mono">${r.type||""}</span></td>
              <td class="cell-name mono">${escapeHtml(r.name||"")}</td>
              <td class="cell-content-wrap">${contentHTML}</td>
              <td class="cell-ttl">${r.ttl||""}</td>
              <td class="cell-prox">${prox}</td>
              <td class="cell-act">
                <div class="row-actions">
                  <button class="btn-mini" data-act="load" data-id="${r.id}">Load</button>
                  ${admin? `<button class="btn-mini" data-act="edit" data-id="${r.id}">Edit</button>`:""}
                  ${admin? `<button class="btn-mini ghost" data-act="delete" data-id="${r.id}">Delete</button>`:""}
                </div>
              </td>`;
            tr.dataset.row = JSON.stringify(r);
            el.cfBody.appendChild(tr);
          }
        }
        el.searchMsg.textContent=`Page ${data.page||page} ‚Äì ${rows.length} record(s)`;
      }catch(err){
        el.searchMsg.textContent="‚ùå "+err.message;
      }
    }
    runSearch();

    function typeSelectHTML(cur){
      const types=["A","AAAA","CAA","CERT","CNAME","DNSKEY","DS","HTTPS","LOC","MX","NAPTR","NS","OPENPGPKEY","PTR","SMIMEA","SRV","SSHFP","SVCB","TLSA","TXT","URI"];
      return `<select class="sel edit-type">
        ${types.map(t=>`<option value="${t}" ${t===cur?'selected':''}>${t}</option>`).join("")}
      </select>`;
    }
    function proxToggleHTML(checked){ return `<label class="switch switch-mini"><input class="edit-prox" type="checkbox" ${checked?'checked':''}/><span class="slider"></span></label>`; }

    function startEdit(tr, row){
      if(tr.dataset.editing==="1") return;
      tr.dataset.editing="1";
      tr.querySelector(".cell-type").innerHTML = typeSelectHTML(row.type||"A");
      tr.querySelector(".cell-name").innerHTML = `<input class="inpt edit-name" value="${escapeHtmlAttr(row.name||"")}" />`;
      tr.querySelector(".cell-content-wrap").innerHTML = `<input class="inpt edit-content" value="${escapeHtmlAttr(row.content||"")}" />`;
      tr.querySelector(".cell-ttl").innerHTML = `<input class="inpt edit-ttl" type="number" min="1" value="${row.ttl||300}" />`;
      const proxCell = tr.querySelector(".cell-prox");
      if(["A","AAAA","CNAME"].includes(row.type||"")) proxCell.innerHTML = proxToggleHTML(!!row.proxied);
      else proxCell.innerHTML = `<span class="small muted">‚Äî</span>`;
      tr.querySelector(".cell-act .row-actions").innerHTML = `
        <button class="btn-mini" data-act="save" data-id="${row.id}">Save</button>
        <button class="btn-mini ghost" data-act="cancel" data-id="${row.id}">Cancel</button>
      `;
    }
    function cancelEdit(tr, row){
      tr.dataset.editing="0";
      const cls = isIP(row.content||"") ? 'ip' : 'host';
      tr.querySelector(".cell-type").innerHTML = `<span class="mono">${row.type||""}</span>`;
      tr.querySelector(".cell-name").innerHTML = `${escapeHtml(row.name||"")}`;
      tr.querySelector(".cell-content-wrap").innerHTML = cls==='ip'
        ? `<span class="cell-content ip mono">${escapeHtml(row.content||"")}</span>`
        : `<span class="cell-content host mono">${escapeHtml(row.content||"")}</span>`;
      tr.querySelector(".cell-ttl").innerHTML = `${row.ttl||""}`;
      tr.querySelector(".cell-prox").innerHTML = (["A","AAAA","CNAME"].includes(row.type) && row.proxied) ? "üü© proxied" : "‚¨ú DNS only";
      tr.querySelector(".cell-act .row-actions").innerHTML = `
        <button class="btn-mini" data-act="load" data-id="${row.id}">Load</button>
        <button class="btn-mini" data-act="edit" data-id="${row.id}">Edit</button>
        <button class="btn-mini ghost" data-act="delete" data-id="${row.id}">Delete</button>
      `;
    }
    async function saveEdit(tr, row){
      const t = tr.querySelector(".edit-type").value;
      const nameRaw = tr.querySelector(".edit-name").value;
      const content = tr.querySelector(".edit-content").value.trim();
      const ttl = parseInt(tr.querySelector(".edit-ttl").value,10) || row.ttl || 300;
      const name = normalizeHost(nameRaw);
      if(!name){ el.searchMsg.textContent=t("hostReq"); return; }
      if(!content){ el.searchMsg.textContent=t("contentReq"); return; }
      const payload = { type:t, name, content, ttl };
      if(t==="MX"){ payload.priority = (row.priority!=null) ? row.priority : 10; }
      if(["A","AAAA","CNAME"].includes(t)){
        const prox = tr.querySelector(".edit-prox"); payload.proxied = prox ? !!prox.checked : false;
      }
      el.searchMsg.textContent="Saving‚Ä¶";
      try{
        const res=await apiFetch(buildAPI("/dns/"+row.id),{method:"PUT", headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload)});
        const data=await res.json();
        if(!data.success) throw new Error(data.error||"Update failed");
        pushHistory({action:"update", before:row, after:data.result||payload});
        el.searchMsg.textContent=t("updated"); await runSearch();
      }catch(err){ el.searchMsg.textContent="‚ùå "+err.message; }
    }

    el.cfBody.addEventListener("click", async (e)=>{
      const btn=e.target.closest("button"); if(!btn) return;
      const act=btn.getAttribute("data-act"); const tr=btn.closest("tr"); const row=JSON.parse(tr.dataset.row||"{}");

      if(act==="load"){ loadRowIntoForm(row); show("ok",t("loaded")); window.scrollTo({top:0,behavior:"smooth"}); }
      if(act==="edit"){ if(localStorage.getItem("admin")!=="1") return; startEdit(tr,row); }
      if(act==="cancel"){ cancelEdit(tr,row); }
      if(act==="save"){ await saveEdit(tr,row); }
      if(act==="delete"){
        if(localStorage.getItem("admin")!=="1") return;
        if(!confirm(`Delete DNS record?\n${row.type} ${row.name} -> ${row.content}`)) return;
        el.searchMsg.textContent="Deleting‚Ä¶";
        try{
          const res=await apiFetch(buildAPI("/dns/"+row.id),{method:"DELETE"}); const data=await res.json();
          if(!data.success) throw new Error(data.error||"Delete failed");
          pushHistory({action:"delete", before:row, after:null});
          el.searchMsg.textContent=t("deleted"); await runSearch();
        }catch(err){ el.searchMsg.textContent="‚ùå "+err.message; }
      }
    });

    function loadRowIntoForm(row){
      el.type.value=row.type||"A"; renderTypeAware();
      el.host.value=row.name||""; el.content.value=row.content||"";
      el.ttl.value=String(row.ttl||300);
      if(["A","AAAA","CNAME"].includes(row.type||"")) el.proxied.checked=!!row.proxied; else el.proxied.checked=false;
      if(row.type==="MX" && row.priority!=null){ el.priority.value = row.priority; el.prioRow.style.display="grid"; }
      updateAppendPreview();
    }

    /* =========================
       Settings defaults
       ========================= */
    function initSettingsFromConfig(){
      // nothing else, zones already applied
    }
    initSettingsFromConfig();

    /* =========================
       PWA manifest + service worker
       ========================= */
    (function setupPWA(){
      const manifest = {
        name: "JVPN VIP DNS CREATOR",
        short_name: "JVPN DNS",
        start_url: ".",
        display: "standalone",
        background_color: "#0b1220",
        theme_color: "#14b8a6",
        icons: []
      };
      const blob = new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"});
      const url = URL.createObjectURL(blob);
      const link = document.createElement("link"); link.rel="manifest"; link.href=url; document.head.appendChild(link);

      if("serviceWorker" in navigator){
        const sw = `
self.addEventListener('install', e=>{ self.skipWaiting(); e.waitUntil(caches.open('shell').then(c=>c.addAll(['./']))); });
self.addEventListener('activate', e=>self.clients.claim());
self.addEventListener('fetch', e=>{
  const req=e.request;
  if(req.method!=='GET'){ return; }
  e.respondWith(
    caches.match(req).then(res=> res || fetch(req).then(r=>{
      const rc=r.clone(); caches.open('dyn').then(c=>c.put(req,rc)); return r;
    }).catch(()=>caches.match('./')))
  );
});`;
        const swBlob = new Blob([sw], {type:"text/javascript"});
        const swUrl = URL.createObjectURL(swBlob);
        navigator.serviceWorker.register(swUrl);
      }
    })();
  </script>
</body>
</html>
